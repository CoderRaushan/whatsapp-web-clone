<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Web Clone</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #111b21;
            color: #e9edef;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Sidebar */
        .sidebar {
            width: 30%;
            min-width: 320px;
            background: #111b21;
            border-right: 1px solid #2a3942;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            background: #202c33;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #2a3942;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #00a884;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .search-container {
            padding: 12px 16px;
            background: #111b21;
            border-bottom: 1px solid #2a3942;
        }

        .search-box {
            background: #2a3942;
            border: none;
            border-radius: 8px;
            padding: 8px 45px 8px 15px;
            width: 100%;
            color: #e9edef;
            font-size: 14px;
        }

        .search-box::placeholder {
            color: #8696a0;
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            background: #111b21;
        }

        .conversation-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #2a3942;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .conversation-item:hover {
            background: #202c33;
        }

        .conversation-item.active {
            background: #2a3942;
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-weight: 500;
            color: #e9edef;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .last-message {
            color: #8696a0;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-time {
            color: #8696a0;
            font-size: 12px;
            white-space: nowrap;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0b141a;
        }

        .chat-header {
            background: #202c33;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #2a3942;
        }

        .contact-details h3 {
            color: #e9edef;
            font-size: 16px;
            font-weight: 500;
        }

        .contact-details p {
            color: #8696a0;
            font-size: 14px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #0b141a;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIwIDJMMjIuMDkgOC4yNkwyOCAyTDI1Ljc0IDguMjZMMzEuMDc0IDRMMjkgMTBMMzQuOTI4IDhMMzAgMTRMMzkgMTJMMzIuNjggMThMMzggMjBMMzIgMjBMMzYuNzMyIDI2TDMwIDE5LjU0TDMzIDI4TDI3IDIyTDMwIDMwTDI0IDI0TDI2IDMwTDIwIDI0TDE0IDMwTDE2IDI0TDEwIDMwTDEzIDI4TDE3IDIyTDExIDI4TDE0IDE5LjU0TDggMjZMMTIgMjBMNiAyMEwxMiAxOEw3IDEyTDE0IDE0TDkgMTBMNCAyOCIgZmlsbD0iIzBkMTQxYSIvPgo8L3N2Zz4K');
        }

        .message {
            margin-bottom: 12px;
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }

        .message.outgoing {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 8px;
            position: relative;
            word-wrap: break-word;
        }

        .message.incoming .message-bubble {
            background: #202c33;
            color: #e9edef;
        }

        .message.outgoing .message-bubble {
            background: #005c4b;
            color: #e9edef;
        }

        .message-text {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .message-meta {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
            font-size: 11px;
            color: #8696a0;
        }

        .message-time {
            color: #8696a0;
        }

        .message-status {
            display: flex;
            align-items: center;
        }

        .status-icon {
            width: 16px;
            height: 12px;
        }

        /* Message Input */
        .message-input-container {
            background: #202c33;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            background: #2a3942;
            border: none;
            border-radius: 20px;
            padding: 12px 15px;
            color: #e9edef;
            font-size: 14px;
            resize: none;
            max-height: 100px;
            outline: none;
        }

        .message-input::placeholder {
            color: #8696a0;
        }

        .send-button {
            background: #00a884;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .send-button:hover {
            background: #06cf9c;
        }

        .send-button svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #8696a0;
            background: #0b141a;
        }

        .welcome-screen h2 {
            color: #e9edef;
            margin-bottom: 16px;
            font-size: 32px;
            font-weight: 300;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #8696a0;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40%;
            }
            
            .chat-area {
                height: 60%;
            }
            
            .sidebar.hidden {
                display: none;
            }
            
            .chat-area.mobile-active {
                height: 100%;
            }
        }

        /* Status indicators */
        .status-sent {
            color: #8696a0;
        }
        .status-delivered {
            color: #8696a0;
        }
        .status-read {
            color: #53bdeb;
        }

        /* Connection status */
        .connection-status {
            position: absolute;
            top: 10px;
            right: 20px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }

        .connected {
            background: #00a884;
            color: white;
        }

        .disconnected {
            background: #f15c6d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">Connecting...</div>
    
    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="avatar">WA</div>
                <h2>WhatsApp</h2>
            </div>
            
            <div class="search-container">
                <input type="text" class="search-box" placeholder="Search or start new chat" id="searchInput">
            </div>
            
            <div class="conversations-list" id="conversationsList">
                <div class="loading">Loading conversations...</div>
            </div>
        </div>
        
        <div class="chat-area" id="chatArea">
            <div class="welcome-screen">
                <h2>WhatsApp Web</h2>
                <p>Send and receive messages without keeping your phone online.</p>
                <p>Select a chat to start messaging.</p>
            </div>
        </div>
    </div>

    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <script>
        class WhatsAppClone {
            constructor() {
                this.socket = null;
                this.currentConversation = null;
                this.conversations = [];
                this.messages = [];
                
                this.initializeSocket();
                this.bindEvents();
                this.loadConversations();
                this.processSampleData();
            }

            initializeSocket() {
                this.socket = io();
                
                this.socket.on('connect', () => {
                    this.updateConnectionStatus(true);
                });
                
                this.socket.on('disconnect', () => {
                    this.updateConnectionStatus(false);
                });
                
                this.socket.on('new_message', (message) => {
                    this.handleNewMessage(message);
                });
                
                this.socket.on('message_status_update', (update) => {
                    this.handleStatusUpdate(update);
                });
            }

            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connectionStatus');
                if (connected) {
                    statusEl.textContent = 'Connected';
                    statusEl.className = 'connection-status connected';
                } else {
                    statusEl.textContent = 'Disconnected';
                    statusEl.className = 'connection-status disconnected';
                }
            }

            bindEvents() {
                // Search functionality
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filterConversations(e.target.value);
                });
                
                // Mobile responsiveness
                window.addEventListener('resize', () => {
                    this.handleResize();
                });
            }

            async loadConversations() {
                try {
                    const response = await fetch('/api/conversations');
                    this.conversations = await response.json();
                    this.renderConversations();
                } catch (error) {
                    console.error('Error loading conversations:', error);
                }
            }

            renderConversations() {
                const listEl = document.getElementById('conversationsList');
                
                if (this.conversations.length === 0) {
                    listEl.innerHTML = '<div class="loading">No conversations yet</div>';
                    return;
                }
                
                listEl.innerHTML = this.conversations.map(contact => `
                    <div class="conversation-item" data-wa-id="${contact.wa_id}" onclick="app.selectConversation('${contact.wa_id}')">
                        <div class="avatar">${this.getInitials(contact.name)}</div>
                        <div class="contact-info">
                            <div class="contact-name">${contact.name}</div>
                            <div class="last-message">${contact.last_message || 'No messages yet'}</div>
                        </div>
                        <div class="message-time">${this.formatTime(contact.last_message_time)}</div>
                    </div>
                `).join('');
            }

            async selectConversation(waId) {
                // Update active conversation
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-wa-id="${waId}"]`).classList.add('active');
                
                this.currentConversation = this.conversations.find(c => c.wa_id === waId);
                
                // Load messages
                await this.loadMessages(waId);
                this.renderChatArea();
                
                // Join socket room
                this.socket.emit('join_conversation', waId);
                
                // Mobile: hide sidebar
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.add('hidden');
                    document.getElementById('chatArea').classList.add('mobile-active');
                }
            }

            async loadMessages(waId) {
                try {
                    const response = await fetch(`/api/conversations/${waId}/messages`);
                    this.messages = await response.json();
                } catch (error) {
                    console.error('Error loading messages:', error);
                    this.messages = [];
                }
            }

            renderChatArea() {
                if (!this.currentConversation) return;
                
                const chatAreaEl = document.getElementById('chatArea');
                chatAreaEl.innerHTML = `
                    <div class="chat-header">
                        <div class="avatar">${this.getInitials(this.currentConversation.name)}</div>
                        <div class="contact-details">
                            <h3>${this.currentConversation.name}</h3>
                            <p>+${this.currentConversation.wa_id}</p>
                        </div>
                    </div>
                    
                    <div class="messages-container" id="messagesContainer">
                        ${this.renderMessages()}
                    </div>
                    
                    <div class="message-input-container">
                        <input type="text" class="message-input" placeholder="Type a message" 
                               id="messageInput" onkeypress="app.handleKeyPress(event)">
                        <button class="send-button" onclick="app.sendMessage()">
                            <svg viewBox="0 0 24 24">
                                <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" />
                            </svg>
                        </button>
                    </div>
                `;
                
                this.scrollToBottom();
            }

            renderMessages() {
                return this.messages.map(message => {
                    const isOutgoing = message.is_outgoing;
                    const messageClass = isOutgoing ? 'outgoing' : 'incoming';
                    
                    return `
                        <div class="message ${messageClass}" data-message-id="${message.id}">
                            <div class="message-bubble">
                                <div class="message-text">${message.text}</div>
                                <div class="message-meta">
                                    <span class="message-time">${this.formatMessageTime(message.timestamp)}</span>
                                    ${isOutgoing ? `<span class="message-status status-${message.status}">${this.getStatusIcon(message.status)}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            getStatusIcon(status) {
                switch (status) {
                    case 'sent': return '✓';
                    case 'delivered': return '✓✓';
                    case 'read': return '✓✓';
                    default: return '⏳';
                }
            }

            handleKeyPress(event) {
                if (event.key === 'Enter') {
                    this.sendMessage();
                }
            }

            async sendMessage() {
                const inputEl = document.getElementById('messageInput');
                const text = inputEl.value.trim();
                
                if (!text || !this.currentConversation) return;
                
                try {
                    const response = await fetch('/api/send-message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            to: this.currentConversation.wa_id,
                            text: text,
                            from: '918329446654'
                        }),
                    });
                    
                    if (response.ok) {
                        inputEl.value = '';
                        // Message will be added via socket event
                    } else {
                        console.error('Failed to send message');
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            }

            handleNewMessage(message) {
                // Update conversations list
                this.loadConversations();
                
                // If message is for current conversation, add it to messages
                if (this.currentConversation && 
                    (message.wa_id === this.currentConversation.wa_id || 
                     message.from === this.currentConversation.wa_id)) {
                    this.messages.push(message);
                    
                    // Add message to UI
                    const messagesContainer = document.getElementById('messagesContainer');
                    if (messagesContainer) {
                        const messageEl = document.createElement('div');
                        messageEl.innerHTML = this.renderSingleMessage(message);
                        messagesContainer.appendChild(messageEl.firstElementChild);
                        this.scrollToBottom();
                    }
                }
            }

            handleStatusUpdate(update) {
                const messageEl = document.querySelector(`[data-message-id="${update.messageId}"]`);
                if (messageEl) {
                    const statusEl = messageEl.querySelector('.message-status');
                    if (statusEl) {
                        statusEl.textContent = this.getStatusIcon(update.status);
                        statusEl.className = `message-status status-${update.status}`;
                    }
                }
            }

            renderSingleMessage(message) {
                const isOutgoing = message.is_outgoing;
                const messageClass = isOutgoing ? 'outgoing' : 'incoming';
                
                return `
                    <div class="message ${messageClass}" data-message-id="${message.id}">
                        <div class="message-bubble">
                            <div class="message-text">${message.text}</div>
                            <div class="message-meta">
                                <span class="message-time">${this.formatMessageTime(message.timestamp)}</span>
                                ${isOutgoing ? `<span class="message-status status-${message.status}">${this.getStatusIcon(message.status)}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            filterConversations(query) {
                const filtered = this.conversations.filter(contact => 
                    contact.name.toLowerCase().includes(query.toLowerCase()) ||
                    contact.wa_id.includes(query)
                );
                
                const listEl = document.getElementById('conversationsList');
                listEl.innerHTML = filtered.map(contact => `
                    <div class="conversation-item" data-wa-id="${contact.wa_id}" onclick="app.selectConversation('${contact.wa_id}')">
                        <div class="avatar">${this.getInitials(contact.name)}</div>
                        <div class="contact-info">
                            <div class="contact-name">${contact.name}</div>
                            <div class="last-message">${contact.last_message || 'No messages yet'}</div>
                        </div>
                        <div class="message-time">${this.formatTime(contact.last_message_time)}</div>
                    </div>
                `).join('');
            }

            async processSampleData() {
                // Sample payloads based on the provided documents
                const samplePayloads = [
                    {
                        "payload_type": "whatsapp_webhook",
                        "_id": "conv1-msg1-user",
                        "metaData": {
                            "entry": [{
                                "changes": [{
                                    "field": "messages",
                                    "value": {
                                        "contacts": [{
                                            "profile": {"name": "Ravi Kumar"},
                                            "wa_id": "919937320320"
                                        }],
                                        "messages": [{
                                            "from": "919937320320",
                                            "id": "wamid.HBgMOTE5OTY3NTc4NzIwFQIAEhggMTIzQURFRjEyMzQ1Njc4OTA=",
                                            "timestamp": "1754400000",
                                            "text": {"body": "Hi, I'd like to know more about your services."},
                                            "type": "text"
                                        }],
                                        "messaging_product": "whatsapp",
                                        "metadata": {
                                            "display_phone_number": "918329446654",
                                            "phone_number_id": "629305560276479"
                                        }
                                    }
                                }],
                                "id": "30164062719905277"
                            }],
                            "gs_app_id": "conv1-app",
                            "object": "whatsapp_business_account"
                        }
                    },
                    {
                        "payload_type": "whatsapp_webhook",
                        "_id": "conv2-msg1-user",
                        "metaData": {
                            "entry": [{
                                "changes": [{
                                    "field": "messages",
                                    "value": {
                                        "contacts": [{
                                            "profile": {"name": "Neha Joshi"},
                                            "wa_id": "929967673820"
                                        }],
                                        "messages": [{
                                            "from": "929967673820",
                                            "id": "wamid.HBgMOTI5OTY3NjczODIwFQIAEhggQ0FBQkNERUYwMDFGRjEyMzQ1NkZGQTk5RTJCM0I2NzY=",
                                            "timestamp": "1754401000",
                                            "text": {"body": "Hi, I saw your ad. Can you share more details?"},
                                            "type": "text"
                                        }],
                                        "messaging_product": "whatsapp",
                                        "metadata": {
                                            "display_phone_number": "918329446654",
                                            "phone_number_id": "629305560276479"
                                        }
                                    }
                                }],
                                "id": "30164062719905279"
                            }],
                            "gs_app_id": "conv2-app",
                            "object": "whatsapp_business_account"
                        }
                    }
                ];

                try {
                    const response = await fetch('/api/process-sample-data', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(samplePayloads)
                    });
                    
                    if (response.ok) {
                        console.log('Sample data processed successfully');
                        // Reload conversations after processing
                        setTimeout(() => this.loadConversations(), 1000);
                    }
                } catch (error) {
                    console.error('Error processing sample data:', error);
                }
            }

            // Utility functions
            getInitials(name) {
                return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            }

            formatTime(timestamp) {
                if (!timestamp) return '';
                const date = new Date(timestamp * 1000);
                const now = new Date();
                
                if (date.toDateString() === now.toDateString()) {
                    return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                } else {
                    return date.toLocaleDateString();
                }
            }

            formatMessageTime(timestamp) {
                const date = new Date(timestamp * 1000);
                return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }

            scrollToBottom() {
                const container = document.getElementById('messagesContainer');
                if (container) {
                    setTimeout(() => {
                        container.scrollTop = container.scrollHeight;
                    }, 100);
                }
            }

            handleResize() {
                if (window.innerWidth > 768) {
                    document.getElementById('sidebar').classList.remove('hidden');
                    document.getElementById('chatArea').classList.remove('mobile-active');
                }
            }
        }

        // Initialize the app
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new WhatsAppClone();
        });
    </script>
</body>
</html>