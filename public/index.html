<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Web Clone</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="connection-status" id="connectionStatus">Connecting...</div>

    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="avatar">WA</div>
                <h2>WhatsApp</h2>
            </div>

            <div class="search-container">
                <input type="text" class="search-box" placeholder="Search or start new chat" id="searchInput">
            </div>

            <div class="conversations-list" id="conversationsList">
                <div class="loading">Loading conversations...</div>
            </div>
        </div>

        <div class="chat-area" id="chatArea">
            <div class="welcome-screen">
                <h2>WhatsApp Web</h2>
                <p>Send and receive messages without keeping your phone online.</p>
                <p>Select a chat to start messaging.</p>
            </div>
        </div>
    </div>

    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <script>
        class WhatsAppClone {
            constructor() {
                this.socket = null;
                this.currentConversation = null;
                this.conversations = [];
                this.messages = [];

                this.initializeSocket();
                this.bindEvents();
                this.loadConversations();
                this.processSampleData();
            }

            initializeSocket() {
                this.socket = io();

                this.socket.on('connect', () => {
                    this.updateConnectionStatus(true);
                });

                this.socket.on('disconnect', () => {
                    this.updateConnectionStatus(false);
                });

                this.socket.on('new_message', (message) => {
                    this.handleNewMessage(message);
                });

                this.socket.on('message_status_update', (update) => {
                    this.handleStatusUpdate(update);
                });
            }

            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connectionStatus');
                if (connected) {
                    statusEl.textContent = 'Connected';
                    statusEl.className = 'connection-status connected';
                } else {
                    statusEl.textContent = 'Disconnected';
                    statusEl.className = 'connection-status disconnected';
                }
            }

            bindEvents() {
                // Search functionality
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filterConversations(e.target.value);
                });

                // Mobile responsiveness
                window.addEventListener('resize', () => {
                    this.handleResize();
                });
            }

            async loadConversations() {
                try {
                    const response = await fetch('/api/conversations');
                    this.conversations = await response.json();
                    this.renderConversations();
                } catch (error) {
                    console.error('Error loading conversations:', error);
                }
            }

            renderConversations() {
                const listEl = document.getElementById('conversationsList');

                if (this.conversations.length === 0) {
                    listEl.innerHTML = '<div class="loading">No conversations yet</div>';
                    return;
                }

                listEl.innerHTML = this.conversations.map(contact => `
                    <div class="conversation-item" data-wa-id="${contact.wa_id}" onclick="app.selectConversation('${contact.wa_id}')">
                        <div class="avatar">${this.getInitials(contact.name)}</div>
                        <div class="contact-info">
                            <div class="contact-name">${contact.name}</div>
                            <div class="last-message">${contact.last_message || 'No messages yet'}</div>
                        </div>
                        <div class="message-time">${this.formatTime(contact.last_message_time)}</div>
                    </div>
                `).join('');
            }

            async selectConversation(waId) {
                // Update active conversation
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-wa-id="${waId}"]`).classList.add('active');

                this.currentConversation = this.conversations.find(c => c.wa_id === waId);

                // Load messages
                await this.loadMessages(waId);
                this.renderChatArea();

                // Join socket room
                this.socket.emit('join_conversation', waId);

                // Mobile: hide sidebar
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.add('hidden');
                    document.getElementById('chatArea').classList.add('mobile-active');
                }
            }

            async loadMessages(waId) {
                try {
                    const response = await fetch(`/api/conversations/${waId}/messages`);
                    this.messages = await response.json();
                } catch (error) {
                    console.error('Error loading messages:', error);
                    this.messages = [];
                }
            }

            renderChatArea() {
                if (!this.currentConversation) return;

                const chatAreaEl = document.getElementById('chatArea');
                chatAreaEl.innerHTML = `
                    <div class="chat-header">
                        <div class="avatar">${this.getInitials(this.currentConversation.name)}</div>
                        <div class="contact-details">
                            <h3>${this.currentConversation.name}</h3>
                            <p>+${this.currentConversation.wa_id}</p>
                        </div>
                    </div>
                    
                    <div class="messages-container" id="messagesContainer">
                        ${this.renderMessages()}
                    </div>
                    
                    <div class="message-input-container">
                        <input type="text" class="message-input" placeholder="Type a message" 
                               id="messageInput" onkeypress="app.handleKeyPress(event)">
                        <button class="send-button" onclick="app.sendMessage()">
                            <svg viewBox="0 0 24 24">
                                <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" />
                            </svg>
                        </button>
                    </div>
                `;

                this.scrollToBottom();
            }

            renderMessages() {
                return this.messages.map(message => {
                    const isOutgoing = message.is_outgoing;
                    const messageClass = isOutgoing ? 'outgoing' : 'incoming';

                    return `
                        <div class="message ${messageClass}" data-message-id="${message.id}">
                            <div class="message-bubble">
                                <div class="message-text">${message.text}</div>
                                <div class="message-meta">
                                    <span class="message-time">${this.formatMessageTime(message.timestamp)}</span>
                                    ${isOutgoing ? `<span class="message-status status-${message.status}">${this.getStatusIcon(message.status)}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            getStatusIcon(status) {
                switch (status) {
                    case 'sent': return '✓';
                    case 'delivered': return '✓✓';
                    case 'read': return '✓✓';
                    default: return '⏳';
                }
            }

            handleKeyPress(event) {
                if (event.key === 'Enter') {
                    this.sendMessage();
                }
            }

            async sendMessage() {
                const inputEl = document.getElementById('messageInput');
                const text = inputEl.value.trim();

                if (!text || !this.currentConversation) return;

                try {
                    const response = await fetch('/api/send-message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            to: this.currentConversation.wa_id,
                            text: text,
                            from: '918329446654'
                        }),
                    });

                    if (response.ok) {
                        inputEl.value = '';
                        // Message will be added via socket event
                    } else {
                        console.error('Failed to send message');
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            }

            handleNewMessage(message) {
                // Update conversations list
                this.loadConversations();

                // If message is for current conversation, add it to messages
                if (this.currentConversation &&
                    (message.wa_id === this.currentConversation.wa_id ||
                        message.from === this.currentConversation.wa_id)) {
                    this.messages.push(message);

                    // Add message to UI
                    const messagesContainer = document.getElementById('messagesContainer');
                    if (messagesContainer) {
                        const messageEl = document.createElement('div');
                        messageEl.innerHTML = this.renderSingleMessage(message);
                        messagesContainer.appendChild(messageEl.firstElementChild);
                        this.scrollToBottom();
                    }
                }
            }

            handleStatusUpdate(update) {
                const messageEl = document.querySelector(
                    `[data-message-id="${update.messageId}"], [data-message-id="${update.meta_msg_id}"]`
                );
                if (messageEl) {
                    const statusEl = messageEl.querySelector('.message-status');
                    if (statusEl) {
                        statusEl.textContent = this.getStatusIcon(update.status);
                        statusEl.className = `message-status status-${update.status}`;
                    }
                }
            }

            renderSingleMessage(message) {
                const isOutgoing = message.is_outgoing;
                const messageClass = isOutgoing ? 'outgoing' : 'incoming';

                return `
                    <div class="message ${messageClass}" data-message-id="${message.id}">
                        <div class="message-bubble">
                            <div class="message-text">${message.text}</div>
                            <div class="message-meta">
                                <span class="message-time">${this.formatMessageTime(message.timestamp)}</span>
                                ${isOutgoing ? `<span class="message-status status-${message.status}">${this.getStatusIcon(message.status)}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            filterConversations(query) {
                const filtered = this.conversations.filter(contact =>
                    contact.name.toLowerCase().includes(query.toLowerCase()) ||
                    contact.wa_id.includes(query)
                );

                const listEl = document.getElementById('conversationsList');
                listEl.innerHTML = filtered.map(contact => `
                    <div class="conversation-item" data-wa-id="${contact.wa_id}" onclick="app.selectConversation('${contact.wa_id}')">
                        <div class="avatar">${this.getInitials(contact.name)}</div>
                        <div class="contact-info">
                            <div class="contact-name">${contact.name}</div>
                            <div class="last-message">${contact.last_message || 'No messages yet'}</div>
                        </div>
                        <div class="message-time">${this.formatTime(contact.last_message_time)}</div>
                    </div>
                `).join('');
            }

            async processSampleData() {
                // Sample payloads based on the provided documents
                const samplePayloads = [
                    {
                        "payload_type": "whatsapp_webhook",
                        "_id": "conv1-msg1-user",
                        "metaData": {
                            "entry": [{
                                "changes": [{
                                    "field": "messages",
                                    "value": {
                                        "contacts": [{
                                            "profile": { "name": "Ravi Kumar" },
                                            "wa_id": "919937320320"
                                        }],
                                        "messages": [{
                                            "from": "919937320320",
                                            "id": "wamid.HBgMOTE5OTY3NTc4NzIwFQIAEhggMTIzQURFRjEyMzQ1Njc4OTA=",
                                            "timestamp": "1754400000",
                                            "text": { "body": "Hi, I'd like to know more about your services." },
                                            "type": "text"
                                        }],
                                        "messaging_product": "whatsapp",
                                        "metadata": {
                                            "display_phone_number": "918329446654",
                                            "phone_number_id": "629305560276479"
                                        }
                                    }
                                }],
                                "id": "30164062719905277"
                            }],
                            "gs_app_id": "conv1-app",
                            "object": "whatsapp_business_account"
                        }
                    },
                    {
                        "payload_type": "whatsapp_webhook",
                        "_id": "conv2-msg1-user",
                        "metaData": {
                            "entry": [{
                                "changes": [{
                                    "field": "messages",
                                    "value": {
                                        "contacts": [{
                                            "profile": { "name": "Neha Joshi" },
                                            "wa_id": "929967673820"
                                        }],
                                        "messages": [{
                                            "from": "929967673820",
                                            "id": "wamid.HBgMOTI5OTY3NjczODIwFQIAEhggQ0FBQkNERUYwMDFGRjEyMzQ1NkZGQTk5RTJCM0I2NzY=",
                                            "timestamp": "1754401000",
                                            "text": { "body": "Hi, I saw your ad. Can you share more details?" },
                                            "type": "text"
                                        }],
                                        "messaging_product": "whatsapp",
                                        "metadata": {
                                            "display_phone_number": "918329446654",
                                            "phone_number_id": "629305560276479"
                                        }
                                    }
                                }],
                                "id": "30164062719905279"
                            }],
                            "gs_app_id": "conv2-app",
                            "object": "whatsapp_business_account"
                        }
                    }
                ];

                try {
                    const response = await fetch('/api/process-sample-data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(samplePayloads)
                    });

                    if (response.ok) {
                        console.log('Sample data processed successfully');
                        // Reload conversations after processing
                        setTimeout(() => this.loadConversations(), 1000);
                    }
                } catch (error) {
                    console.error('Error processing sample data:', error);
                }
            }

            // Utility functions
            getInitials(name) {
                return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            }

            formatTime(timestamp) {
                if (!timestamp) return '';
                const date = new Date(timestamp * 1000);
                const now = new Date();

                if (date.toDateString() === now.toDateString()) {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString();
                }
            }

            formatMessageTime(timestamp) {
                const date = new Date(timestamp * 1000);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            scrollToBottom() {
                const container = document.getElementById('messagesContainer');
                if (container) {
                    setTimeout(() => {
                        container.scrollTop = container.scrollHeight;
                    }, 100);
                }
            }

            handleResize() {
                if (window.innerWidth > 768) {
                    document.getElementById('sidebar').classList.remove('hidden');
                    document.getElementById('chatArea').classList.remove('mobile-active');
                }
            }
        }

        // Initialize the app
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new WhatsAppClone();
        });
    </script>
</body>

</html>